<!DOCTYPE html>
<html>
	<head>
		<title>App Mymy</title>
		<meta charset="utf-8"/>	
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		crossorigin=""/> <!-- leaflet-step1 -->
	</head>
	<body>
<!-- INFOS COORDONNEES -->
        <label>Latitude : </label><span id="latitude"></span>        </br>
        <label>Longitude : </label><span id="longitude"></span>      </br>        
        <label>Altitude : </label><span id="altitude"></span>      </br></br>

<!-- RANDOS -->
		<button id="start">Démarrer</button><p id="startInfo"></p>	</br>
		<button id="stop">Arrêter</button> <p id="stopInfo"></p>	</br>
		<p id="stats"></p>	</br>

<!-- CARTE -->
		<div id="map"></div>
		<style>#map { height: 100vh; }</style>		
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		crossorigin=""></script>


		<script>
			var watchID = navigator.geolocation.watchPosition(success, error, {timeout:10000});
			//navigator.geolocation.getCurrentPosition(success, error); 

			var latitude = document.getElementById('latitude');
			var longitude = document.getElementById('longitude');
			var altitude = document.getElementById('altitude');
			//let position = document.getElementById('position');

			let start = document.getElementById('start');
			let startInfo = document.getElementById('startInfo');
			let stop = document.getElementById('stop');
			let stopInfo = document.getElementById('stopInfo');
			let stats = document.getElementById('stats');

			function success(pos) {
// Centrage de la carte autour des coordonnées		
				var map = L.map('map').setView([pos.coords.latitude, pos.coords.longitude], 14);
				
				L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="https://stamen-tiles-{S}.a.ssl.fastly.net">OpenStreetMap</a> contributors'
				}).addTo(map);

// Affichage position
				var moi = L.circle([pos.coords.latitude, pos.coords.longitude], {
					color: 'blue',
					fillColor: '#00f',
					fillOpacity: 0.5,
					radius: 20
				}).addTo(map);
				console.log("POSITION : "+ pos.coords.latitude + "(lat) - " + pos.coords.longitude + "(lon) - " + pos.coords.altitude + "(alt) ");
				latitude.innerHTML = pos.coords.latitude;
                longitude.innerHTML = pos.coords.longitude;
                if(pos.coords.altitude != null) {altitude.innerHTML = pos.coords.altitude;}


// // Récupération des données de départ et arrivée
// 				stop.disabled = true;
// 				//var altitudeMax;
// 				//var altitudeMin;
// 				var distanceTot;
// 				var A;

// 				start.addEventListener("click",function(){

// 					stop.disabled = false;
// 					start.disabled = true;

// 					startInfo.innerHTML = "Horaire de départ : " + Date() + "</br> Coordonnées : " + pos.coords.altitude + "(m d'altitude) - " + pos.coords.latitude + "(lat) - " + pos.coords.longitude + "(lon)";
// 					//position.innerHTML = "";
					
// 					distanceTot = 0;

// 					A = pos.coords;
// 					console.log("A : "  + A);
// 					altitudeMin = A.altitude;
// 					console.log("altitude min : "  + altitudeMin);
// 					altitudeMax = A.altitude;
// 					console.log("altitude max : "  + altitudeMax);

// 					setInterval(function(){
// 						var B = pos.coords;
	
// // On affiche le petit trajet parcouru en fonction du temps défini
// 						var step = L.polygon([
// 							[A.latitude, A.longitude], //point précédent
// 							[B.latitude, B.longitude] //dernier point
// 						],
// 						{
// 							color: 'red',
// 							fillColor: '#03f',
// 							fillOpacity: 0.5,
// 						}).addTo(map);


// 	// On met à jour la distance totale en km et les dénivelés
// 						distanceTot += Math.round(findDistance(A,B)/1000);
// 						if (altitudeMin>B.altitude) {altitudeMin = B.altitude}
// 						if (altitudeMax<B.altitude) {altitudeMax = B.altitude}


// 	// On met les données du nouveau point sur l'ancien pour le calcul suivant
// 						A = B;

// 					}, 30000); // toutes les 30 secondes

// 				});
// 				stop.addEventListener("click",function(){
// 					stop.disabled = true;
// 					start.disabled = false;

// 					stopInfo.innerHTML = "Horaire d'arrivée : " + Date() + "</br> Coordonnées : " + pos.coords.altitude + "(m d'altitude) - " + pos.coords.latitude + "(lat) - " + pos.coords.longitude + "(lon)";

// 					var B = pos.coords;
// 					var step = L.polygon([
// 						[A.latitude, A.longitude], //point précédent
// 						[B.latitude, B.longitude] //dernier point
// 					],
// 					{
// 						color: 'red',
// 						fillColor: '#03f',
// 						fillOpacity: 0.5,
// 					}).addTo(map);

// 					if (altitudeMin>B.altitude) {altitudeMin = B.altitude}
// 					if (altitudeMax<B.altitude) {altitudeMax = B.altitude}
// 					distanceTot += Math.round(findDistance(A,B)/1000);

// 					stats.innerHTML = "STATISTIQUES </br>Distance totale en km : " + distanceTot + "</br>Altitude entre " + altitudeMin + " et " + altitudeMax +"</br>(soit un dénivelé de : "+ (altitudeMax-altitudeMin)+").";

					//navigator.geolocation.clearWatch(surv);
				// });

				
let sensor = new Magnetometer();
sensor.start();

sensor.onreading = () => {
console.log("Magnetic field along the X-axis " + sensor.x);
console.log("Magnetic field along the Y-axis " + sensor.y);
console.log("Magnetic field along the Z-axis " + sensor.z);
};

sensor.onerror = event => console.log(event.error.name, event.error.message);

				let carte = document.getElementById('map');		
				carte.append(map);
			}

			function error(err) {console.warn(`ERREUR (${err.code}): ${err.message}`);}

			function findDistance(A,B) {
					var R = 6371e3; // R is earth’s radius

					var latA = A.latitude;
					var latB = B.latitude;
					var lonA = A.longitude;
					var lonB = B.longitude;

					var latAradians = (latA)*Math.PI/180;
					var latBradians = (latB)*Math.PI/180;
					var latRadians = (latB-latA)*Math.PI/180;
					var lonRadians = (lonB-lonA)*Math.PI/180;
					// var latAradians = toRadians(latA);
					// var latBradians = toRadians(latB);
					// var latRadians = toRadians(latB-latA);
					// var lonRadians = toRadians(lonB-lonA);

					var x = Math.sin(latRadians/2) * Math.sin(latRadians/2) +
							Math.cos(latAradians) * Math.cos(latBradians) *
							Math.sin(lonRadians/2) * Math.sin(lonRadians/2);
					var y = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));

					var distance = R * y;

					return distance;
				}
		

			
		</script>
	</body>
</html>
