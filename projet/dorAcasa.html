
<!DOCTYPE html>
<html>
	<head>
		<title>App Mymy</title>
		<meta charset="utf-8"/>	
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		crossorigin=""/> <!-- leaflet-step1 -->
	</head>
	<body>  
        <div class="app">
    <!-- INFOS COORDONNEES -->
            <label class="info">Latitude : </label><span id="latitude" class="info"></span>        </br>
            <label class="info">Longitude : </label><span id="longitude" class="info"></span>      </br>        
            <label class="info">Altitude : </label><span id="altitude" class="info"></span>      </br></br>
    <!-- RAYON -->
            <input id="saisieRayon" placeholder="rayon en km" />
            <button id="validRayon" class="button">Valider</button></br> </br>
    <!-- INFOS API -->
            <label class="info">Région : </label><text class="info" id="region"></text>        </br>
            <label class="info">Département : </label><text class="info" id="departement"></text>        </br>
            <label class="info">Commune : </label><text class="info" id="commune"></text>        </br>
            <label class="info">Population : </label><text class="info" id="population"></text>        </br>
            <label class="info">Surface : </label><text class="info" id="surface"></text>        </br></br>
    <!-- CARTE -->
            <div id="map"></div>
        </div> 
        <style>
            #app { width:100%; height:100%; margin:0; }
            #map { height: 100vh; } /* ----------- */
            .button {font-size:xx-large}
            .info {font-size:large;}
        </style>	
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>


        <script>

            navigator.geolocation.getCurrentPosition(success, error);

            function success(pos) {				
// Centrage de la carte autour des coordonnées
                var crd1 = pos.coords;
                var map = L.map('map').setView([crd1.latitude, crd1.longitude], 10);          
                L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://stamen-tiles-{S}.a.ssl.fastly.net">OpenStreetMap</a> contributors'
                }).addTo(map);

// Affichage de la position (avec altitude si accessible)
                var msg = 'vous êtes ici';
                document.getElementById('latitude').innerHTML = crd1.latitude;
                document.getElementById('longitude').innerHTML = crd1.longitude;
                if(crd1.altitude != null) {
                    msg = 'vous êtes ici à une altitude de ' + crd1.altitude + 'm.';
                    document.getElementById('altitude').innerHTML = crd1.altitude;
                }
                L.marker([crd1.latitude, crd1.longitude]).addTo(map)
                    .bindPopup(msg)
                    .openPopup();

// Affichage du rayon saisi
                document.getElementById('validRayon').addEventListener("click", function(){
                    var circle = L.circle([document.getElementById('latitude').innerText, document.getElementById('longitude').innerText], {
                        color: 'green',
                        fillColor: '#0fc',
                        fillOpacity: 0.5,
                        radius: document.getElementById('saisieRayon').value*1000
                    }).addTo(map);
                });

// Contours de la commune sur la carte et des infos de l'API 
                var url = "https://geo.api.gouv.fr/communes?lat="+document.getElementById('latitude').innerText+"&lon="+document.getElementById('longitude').innerText+"&fields=nom,code,codesPostaux,centre,surface,contour,codeDepartement,departement,codeRegion,region,population&format=geojson&geometry=contour";

                function reqListener () {
                    L.geoJson(JSON.parse(this.response)).addTo(map);
                    document.getElementById('region').innerHTML = JSON.parse(this.response).features[0].properties.region.nom;
                    document.getElementById('departement').innerHTML = JSON.parse(this.response).features[0].properties.departement.nom +" ("+JSON.parse(this.response).features[0].properties.departement.code + ").";
                    document.getElementById('commune').innerHTML = JSON.parse(this.response).features[0].properties.nom;
                    document.getElementById('population').innerHTML = JSON.parse(this.response).features[0].properties.population + " habitants.";
                    document.getElementById('surface').innerHTML = JSON.parse(this.response).features[0].properties.surface + " m2.";
                }
                var oReq = new XMLHttpRequest();
                oReq.addEventListener("load", reqListener);
                oReq.open("GET", url);
                oReq.send();       

// Position choisie    
                map.on('click', function(e) {
                    var latitude2 = e.latlng.lat;
                    var longitude2 = e.latlng.lng
                    var msg2 = 'point choisi';
                    document.getElementById('latitude').innerHTML = latitude2;
                    document.getElementById('longitude').innerHTML = longitude2;      
                    L.marker([latitude2, longitude2]).addTo(map)
                    .bindPopup(msg2)
                    .openPopup();
    
                // contours de la commune sur la carte et infos de l'API 
                var url2 = "https://geo.api.gouv.fr/communes?lat="+latitude2+"&lon="+longitude2+"&fields=nom,code,codesPostaux,centre,surface,contour,codeDepartement,departement,codeRegion,region,population&format=geojson&geometry=contour";
                function reqListener () {
                    L.geoJson(JSON.parse(this.response)).addTo(map);
                    document.getElementById('region').innerHTML = JSON.parse(this.response).features[0].properties.region.nom;
                    document.getElementById('departement').innerHTML = JSON.parse(this.response).features[0].properties.departement.nom +" ("+JSON.parse(this.response).features[0].properties.departement.code + ").";
                    document.getElementById('commune').innerHTML = JSON.parse(this.response).features[0].properties.nom;
                    document.getElementById('population').innerHTML = JSON.parse(this.response).features[0].properties.population + " habitants.";
                    document.getElementById('surface').innerHTML = JSON.parse(this.response).features[0].properties.surface + " m2.";
                }
                var oReq = new XMLHttpRequest();
                oReq.addEventListener("load", reqListener);
                oReq.open("GET", url2);
                oReq.send();  
                
        // On affiche la distance entre les deux points
                var msgd = "distance";
                var distance = L.polygon([
                    [crd1.latitude, crd1.longitude], //position géolocalisée
                    [latitude2, longitude2] //point choisi
                ],
                {
                    color: 'red',
                    fillColor: '#03f',
                    fillOpacity: 0.5,
                }).addTo(map);
                distance = Math.round(findDistance(crd1.latitude, crd1.longitude, latitude2, longitude2)/1000);
                alert("La distance à vol d'oiseau entre le point choisi et votre position géolocalisée est de : \n" + distance + "km.");

                });

// Affichage de la carte
                let carte = document.getElementById('map');		
                carte.append(map);

            }

            function error(err) {console.warn(`ERREUR (${err.code}): ${err.message}`);}
    
            function findDistance(latA,lonA,latB,lonB) {
                var R = 6371e3; // radius de la Terre

                var latAradians = (latA)*Math.PI/180;
                var latBradians = (latB)*Math.PI/180;
                var latRadians = (latB-latA)*Math.PI/180;
                var lonRadians = (lonB-lonA)*Math.PI/180;

                var x = Math.sin(latRadians/2) * Math.sin(latRadians/2) +
                        Math.cos(latAradians) * Math.cos(latBradians) *
                        Math.sin(lonRadians/2) * Math.sin(lonRadians/2);
                var y = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));

                var distance = R * y;

                return distance;
            }

		</script>
	</body>
</html>