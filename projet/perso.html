<!DOCTYPE html>
<html>
  <head>
    <title>test step 50m</title>
    <style>
        #app { width:100%; height:100%; margin:0; }
        #map { width:100%; height:100%; margin:0; position: absolute; z-index: 1;}
		.button {font-size:xx-large}
		.info {font-size:large;}
    </style>

  </head>
  
  <body>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    
    <div id="app">
		<p id="info" class="info">INFOS</p></br>
		<div id="buttons">
			<button id="position" class="button" onclick="zoomOnPosition()">Ma position</button>     
			<button id="start" class="button" onclick="onStart()">Démarrer</button>     
			<button id="stop" class="button" onclick="onStop()">Arrêter</button>
			<button id="stat" class="button" onclick="myPerf()">Statistiques</button>
		</div>
	</br></br>
	<!-- ------------------------------------------------------------------------------------------- -->
		<div id="infoStartStop">
			<p id="startInfo" class="info">START</p>	 
			<p id="stopInfo" class="info">STOP</p>  
			<p id="dataInfo" class="info">...</p>  
		</div>
	</br></br>
	<!-- ------------------------------------------------------------------------------------------- -->
    	<div  id = "map"> </div>
	</br></br>
	</div>

    <script>
		var dataInfo = document.getElementById('dataInfo'); //-----------------------------------
        var info = document.getElementById('info');
		let position = document.getElementById('position');
		let start = document.getElementById('start');
        let stop = document.getElementById('stop');
        stop.disabled = true;
		let stat = document.getElementById('stat');
        stat.disabled = true;
	//declare global data
		let startP;
		let endP;
		var currentP;
		var lastP;
		var distanceTot;
		var altitudeMax;
		var altitudeMin;
		var rota_;
	//show map
        var vectorSource = new ol.source.Vector();
        vectorLayer = new ol.layer.Vector({source: vectorSource});
        const view = new ol.View({center: [10,10], zoom: 0, projection: 'EPSG:4326'}); //------------------------------------------------
        const layers = [new ol.layer.Tile({source: new ol.source.OSM(),}), vectorLayer];
        const map = new ol.Map({ layers: layers, target: 'map', view: view,});
        const geolocation = new ol.Geolocation({ trackingOptions: { enableHighAccuracy: true }, projection: view.getProjection(),});
        geolocation.setTracking(1);   
	//compass icon
        const iconCar = new ol.Feature({ name: 'Null Island', population: 4000, rainfall: 500, size: [5, 5],});
        const iconStyle = new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0,5, 1],
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                src: 'https://freeiconshop.com/wp-content/uploads/edd/location-arrow-solid.png',
                rotateWithView: "false",
                scale: 0.1,
            })        
        });
        iconCar.setStyle(iconStyle);
        new ol.layer.Vector({map: map, source: new ol.source.Vector({features: [iconCar],}),});

	//update map orientation
		window.addEventListener("deviceorientation", handleOrientation, true);
		
	//icon on coordinates and show info 
        navigator.geolocation.watchPosition(function(pos) {
            iconCar.setGeometry([pos.coords.longitude, pos.coords.latitude] ? new ol.geom.Point([pos.coords.longitude, pos.coords.latitude]) : null);
			currentP = pos.coords;
		//if walking : zoom on my position, zoom check altitudes min/max
			if (start.disabled == true){
				zoomOnPosition(20);
				if (altitudeMin>currentP.altitude) {altitudeMin = currentP.altitude}
				if (altitudeMax<currentP.altitude) {altitudeMax = currentP.altitude}
			//every 20' : calculate distance and track steps
				const myTimeout = setTimeout(() => {
					if (findDistance(lastP,currentP) > 50) { //----------------------------------------------------------
						drawPoint([currentP.longitude, currentP.latitude], 2, '#0000FF'); // little blue walking point
						drawLine([[currentP.longitude, currentP.latitude],[lastP.longitude, lastP.latitude]]); 
						distanceTot += (Math.round(findDistance(A,B)))/1000;
						lastP = {latitude : currentP.latitude, longitude : currentP.longitude, altitude: Math.round(currentP.altitude)};//Change old coordinate to new for next operation
					}
					dataInfo.innerHTML = "Distance parcourue : " + distanceTot*1000 +"(m)   -   entre " +altitudeMin+" et " +altitudeMax + " d'altitude";
				}, 20000);			 
			}
		});

//Center map on position
		function zoomOnPosition(zoom) {
			if (zoom == null) {zoom =18;}
			view.setZoom(zoom);
			view.setCenter([currentP.longitude, currentP.latitude]);
			info.innerHTML = "POSITION : " + currentP.latitude + "(lat) - " + currentP.longitude + "(lon) - " + Math.round(currentP.altitude) + "(m) </br> "+ currentP.accuracy +"(ac)   -   "+ currentP.altitudeAccuracy +"(alt ac)." ;
		}
    
//Start button : track walking
		function onStart(){
			startP = {latitude : currentP.latitude, longitude : currentP.longitude, altitude: Math.round(currentP.altitude)};
			stop.disabled = false;
			start.disabled = true;
			position.disabled = true;
			distanceTot = 0;
			altitudeMax = startP.altitude;
			altitudeMin = startP.altitude;
		//show starting point
			drawPoint([startP.longitude, startP.latitude], 5, '#FF0000'); // medium red starting point
			lastP = {latitude : startP.latitude, longitude : startP.longitude, altitude: startP.altitude};	
		}

//Stop button : finish walking and edit stats
		function onStop(){
			endP = {latitude : currentP.latitude, longitude : currentP.longitude, altitude: Math.round(currentP.altitude)};
			stat.disabled = false;
			stop.disabled = true;
			start.disabled = false;
			position.disabled = false;
		// show last step
			drawPoint([endP.longitude, endP.latitude], 10, '#FF0000'); // big red ending point
			drawLine([[endP.longitude, endP.latitude],[lastP.longitude, lastP.latitude]]); 
		//update stats
			distanceTot += (Math.round(findDistance(endP, lastP)))/1000;
			if (altitudeMin>endP.altitude) {altitudeMin = endP.altitude}
			if (altitudeMax<endP.altitude) {altitudeMax = endP.altitude}
			dataInfo.innerHTML = "Distance parcourue : " + distanceTot*1000 +"(m)   -   entre " +altitudeMin+" et " +altitudeMax + " d'altitude";
		//zoom out to show path
			zoomOnPosition(16); //---------------------
		}

//Stats button
		function myPerf() {
			stat.disabled = true;
			info.innerHTML = "STATISTIQUES : </br>Distance totale en km : " + distanceTot + "</br>Altitude entre " + Math.round(altitudeMin) + " et " + Math.round(altitudeMax) +"</br>(soit un dénivelé de : "+ Math.round(altitudeMax-altitudeMin)+").";
		}

//Compass orientation        
        function compassHeading(alpha, beta, gamma) {
            var alphaRad = -alpha * (Math.PI / 180);
            var betaRad = beta * (Math.PI / 180);
            var gammaRad = gamma * (Math.PI / 180);
            betaRad = 1.5707963268;
            var cA = Math.cos(alphaRad);
            var sA = Math.sin(alphaRad);
            var cB = Math.cos(betaRad);
            var sB = Math.sin(betaRad);
            var cG = Math.cos(gammaRad);
            var sG = Math.sin(gammaRad);
            var rA = - cA * sG - sA * sB * cG;
            var rB = - sA * sG + cA * sB * cG;
            var rC = - cB * cG;
            var compassHeading = Math.atan(rA / rB);
            if(rB < 0) {
                compassHeading += Math.PI;
            }else if(rA < 0) {
                compassHeading += 2 * Math.PI;
            }
            return compassHeading;
        }

//Update map on compass
        function handleOrientation(event) {
            absolute = event.absolute;
            alpha    = event.alpha;
            beta     = event.beta;
            gamma    = event.gamma;
            if(isNaN(rota_)) {
                rota_ = compassHeading(alpha, beta, gamma);
            }else{
                eski_yon = rota_;
                rota_ = compassHeading(alpha, beta, gamma);   
            }
            if(rota_ != null && !isNaN(rota_)) {
                map.getView().setRotation(rota_);
            }
            //view.setCenter([longitude.innerHTML,latitude.innerHTML]);
        }

//Distance between two points
		function findDistance(A,B) {
			let latA = A.latitude;
			let latB = B.latitude;
			let lonA = A.longitude;
			let lonB = B.longitude;
			let latAradians = (latA)*Math.PI/180;
			let latBradians = (latB)*Math.PI/180;
			let latRadians = (latB-latA)*Math.PI/180;
			let lonRadians = (lonB-lonA)*Math.PI/180;
			let x = Math.sin(latRadians/2) * Math.sin(latRadians/2) + Math.cos(latAradians) * Math.cos(latBradians) * Math.sin(lonRadians/2) * Math.sin(lonRadians/2);
			let y = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
			let distance = y * 6371e3; // earth’s radius;
			return distance;
		}

//Draw  ---------------------------------------------------------------------------------------------------------------
		function drawPoint(coordP, radiusP, colorP)
		{
			var pointStroke = new ol.style.Stroke({color: colorP ,width: 1});
			var pointFill = new ol.style.Fill({color: colorP});
			var circle = new ol.style.Circle({fill: pointFill, stroke: pointStroke, radius: radiusP});
			var style = new ol.style.Style({image: circle});

			var pointFeature = new ol.Feature({});

			pointFeature.setStyle(style);
			new ol.layer.Vector({map: map, source: new ol.source.Vector({features: [pointFeature],}),});
			pointFeature.setGeometry(coordP ? new ol.geom.Point(coordP) : null);
		}

		function drawLine(coordsList) {
			var line = new ol.geom.LineString(coordsList);
			var lineStyle= new ol.style.Style({
				stroke: new ol.style.Stroke({color: '#000000',width: 1})
			});
			var lineFeature = new ol.Feature({
				geometry: line
			});
			lineFeature.setStyle(lineStyle);
			new ol.layer.Vector({map: map, source: new ol.source.Vector({features: [lineFeature],}),});
			lineFeature.setGeometry(line);
		}

    </script>
  </body>
</html>
