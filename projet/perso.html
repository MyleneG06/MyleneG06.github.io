<!DOCTYPE html>
<html>
	<head>
		<title>App Mymy</title>
		<meta charset="utf-8"/>	
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		crossorigin=""/> <!-- leaflet-step1 -->
	</head>
	<body>

	<!-- RANDO -->
	</br>
	<p id="position"></p>
	</br>
	<button id="start">Démarrer</button><button id="stop">Arrêter</button> 
	</br>
	<p id="stats"></p>
	</br>

	<!-- RAYON -->
		<p>Tracer un rayon autour de ma position : </br> (pour effacer, recharger la page)</p>
		<input id="saisierayon" placeholder="rayon en km" />
		<button id="validsaisie">valider rayon</button>
	</br> </br>

	<!-- INFOS -->
		<label>Région : </label><text id="region"></text>
	</br>
		<label>Département : </label><text id="departement"></text>
	</br>
		<label>Commune : </label><text id="commune"></text>
	</br>
		<label>Population : </label><text id="population"></text>
	</br>
		<label>Surface : </label><text id="surface"></text>
	</br></br>

	<!-- CARTE -->
		<div id="map"></div>
		<style>#map { height: 100vh; }</style>		
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		crossorigin=""></script>

		<script>
		
			navigator.geolocation.getCurrentPosition(success, error); 

			let position = document.getElementById('position');
			let start = document.getElementById('start');
			let startInfo = document.getElementById('startInfo');
			let stop = document.getElementById('stop');
			let stopInfo = document.getElementById('stopInfo');
			let stats = document.getElementById('stats');

			let rayon = document.getElementById('validsaisie')
			let saisie = document.getElementById('saisierayon');

			let region = document.getElementById('region');	
			let departement = document.getElementById('departement');	
			let commune = document.getElementById('commune');	
			let population = document.getElementById('population');	
			let surface = document.getElementById('surface');

			function success(pos) {
				
				var crd = pos.coords;
				var map = L.map('map').setView([crd.latitude, crd.longitude], 12);
				
				L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="https://stamen-tiles-{S}.a.ssl.fastly.net">OpenStreetMap</a> contributors'
				}).addTo(map);


// Affichage position en temps réel
				L.marker([crd.latitude, crd.longitude]).addTo(map)
					.bindPopup('vous êtes ici à une altitude de ' + crd.altitude + 'm.')
					.openPopup();
				
				position.innerHTML = "POSITION EN TEMPS REEL : </br> Coordonnées : "+ pos.coords.latitude + "(lat) - " + pos.coords.longitude + "(lon) - " + pos.coords.altitude + "(alt) </br> Horaire : " + Date(pos.timestamp);


// Affichage du rayon saisi
				rayon.addEventListener("click", function(){
					var circle = L.circle([crd.latitude, crd.longitude], {
					color: 'green',
					fillColor: '#0fc',
					fillOpacity: 0.5,
					radius: saisie.value*1000
				}).addTo(map);})


// Affichage des contours de la commune sur la carte et des infos dans le formumaire 
				var url1 = "https://geo.api.gouv.fr/departements/06/communes?fields=nom,code,codesPostaux,codeDepartement,codeRegion,population&format=geojson&geometry=centre";
				var url = "https://geo.api.gouv.fr/communes?lat="+crd.latitude+"&lon="+crd.longitude+"&fields=nom,code,codesPostaux,centre,surface,contour,codeDepartement,departement,codeRegion,region,population&format=geojson&geometry=contour";

				function reqListener () {
					L.geoJson(JSON.parse(this.response)).addTo(map);
					region.innerHTML = JSON.parse(this.response).features[0].properties.region.nom;
					departement.innerHTML = JSON.parse(this.response).features[0].properties.departement.nom +" ("+JSON.parse(this.response).features[0].properties.departement.code + ").";
					commune.innerHTML = JSON.parse(this.response).features[0].properties.nom;
					population.innerHTML = JSON.parse(this.response).features[0].properties.population + " habitants.";
					surface.innerHTML = JSON.parse(this.response).features[0].properties.surface + " m2.";
				}

				var oReq = new XMLHttpRequest();
				oReq.addEventListener("load", reqListener);
				oReq.open("GET", url);
				oReq.send();


// Récupération des données de départ et arrivée
				stop.disabled = true;
				var altitudeMax;
				var altitudeMin;
				var distanceTot;
				let infoStart; 
				let infoStop;
				var A;

				start.addEventListener("click",function(){
					stop.disabled = false;
					start.disabled = true;
					
					distanceTot = 0;
					infoStart = pos;

					A = infoStart.coords;
					altitudeMin = A.altitude;
					altitudeMax = A.altitude;

					setInterval(function(){
						var B = pos.coords;
	
						
	// On affiche le petit trajet parcouru en fonction du temps défini
						var step = L.polygon([
							[A.latitude, A.longitude], //point précédent
							[B.latitude, B.longitude] //dernier point
						],
						{
							color: 'red',
							fillColor: '#03f',
							fillOpacity: 0.5,
						}).addTo(map);


	// On met à jour la distance totale en km et les dénivelés
						distanceTot += Math.round(findDistance(A,B)/1000);
						if (altitudeMin>B.altitude) {altitudeMin = B.altitude}
						if (altitudeMax<B.altitude) {altitudeMax = B.altitude}


	// On met les données du nouveau point sur l'ancien pour le calcul suivant
						A = B;

					}, 30000); // toutes les 30 secondes

				});
				stop.addEventListener("click",function(){
					stop.disabled = true;
					start.disabled = false;

					infoStop = pos;
					//
					var B = pos.coords;
					var step = L.polygon([
						[A.latitude, A.longitude], //point précédent
						[B.latitude, B.longitude] //dernier point
					],
					{
						color: 'red',
						fillColor: '#03f',
						fillOpacity: 0.5,
					}).addTo(map);
					distanceTot += Math.round(findDistance(A,B)/1000);
					stats.innerHTML = "STATISTIQUE pour "+Date(pos.timestamp)+"</br>Distance totale en km : " + distanceTot + "</br>Altitude entre " + altitudeMin + " et " + altitudeMax +"</br>(soit un dénivelé de : "+ (altitudeMax-altitudeMin)+").";
				});

				function findDistance(A,B) {
					var R = 6371e3; // R is earth’s radius

					var latA = A.latitude;
					var latB = B.latitude;
					var lonA = A.longitude;
					var lonB = B.longitude;

					var latAradians = (latA)*Math.PI/180;
					var latBradians = (latB)*Math.PI/180;
					var latRadians = (latB-latA)*Math.PI/180;
					var lonRadians = (lonB-lonA)*Math.PI/180;
					// var latAradians = toRadians(latA);
					// var latBradians = toRadians(latB);
					// var latRadians = toRadians(latB-latA);
					// var lonRadians = toRadians(lonB-lonA);

					var x = Math.sin(latRadians/2) * Math.sin(latRadians/2) +
							Math.cos(latAradians) * Math.cos(latBradians) *
							Math.sin(lonRadians/2) * Math.sin(lonRadians/2);
					var y = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));

					var distance = R * y;

					return distance;
				}
				

				let carte = document.getElementById('map');		
				carte.append(map);
			}


			function error(err) {console.warn(`ERREUR (${err.code}): ${err.message}`);}
		

			
		</script>
	</body>
</html>