<!DOCTYPE html>
<html>
  <head>
    <title>Test</title>
    <style>
        html,body,#map { width:100%; height:100%; margin:0; }
        #map {position: absolute; z-index: 5;}
		.button {width: 150px; height: 50px; font-size: 20px;}
    </style>

  </head>
  
  <body>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
<!-- INFOS COORDONNINATES -->
	<p id="currentInfo">CURRENT</p>
    <label>Latitude : </label><span id="latitude"></span>        </br>
    <label>Longitude : </label><span id="longitude"></span>      </br>        
    <label>Altitude : </label><span id="altitude"></span>      </br>
    <label>Précision : </label><span id="accuracy"></span>  </br></br>
<!-- BUTTONS WALKING -->
    <button id="start" class="button" onclick="onStart()">Démarrer</button>
	<p id="startInfo">START</p>	
	<!-- <label>Lat : </label><span id="latPstart"></span>        </br>
    <label>Lon : </label><span id="lonPstart"></span>      </br>        
    <label>Alt : </label><span id="altPstart"></span>      </br></br> -->

	<p id="lastInfo">LAST</p>
	<!-- <label>Lat : </label><span id="latPlast"></span>        </br>
    <label>Lon : </label><span id="lonPlast"></span>      </br>        
    <label>Alt : </label><span id="altPlast"></span>      </br></br> -->
		    
	<button id="stop" class="button" onclick="onStop()">Arrêter</button>
    <p id="stopInfo">STOP</p>
	<!-- <label>Lat : </label><span id="latPstop"></span>        </br>
    <label>Lon : </label><span id="lonPstop"></span>      </br>        
    <label>Alt : </label><span id="altPstop"></span>      </br></br> -->

	<p id="stats"></p>	</br>
<!-- MAP -->
    <div  id = "map"> </div>

    <script>
        var latitude = document.getElementById('latitude');
        var longitude = document.getElementById('longitude');
        var altitude = document.getElementById('altitude');
        let start = document.getElementById('start');
        // let startInfo = document.getElementById('startInfo');
        let stop = document.getElementById('stop');
        // let stopInfo = document.getElementById('stopInfo');
        let stats = document.getElementById('stats');

//initialize data and show map
		let startP;
		let endP;
		var currentP;
		var lastP;
		var distanceTot;
		var altitudeMax;
		var altitudeMin;

		var rota_;
        var vectorSource = new ol.source.Vector();
        vectorLayer = new ol.layer.Vector({source: vectorSource});
        const view = new ol.View({center: [10,10], zoom: 20, projection: 'EPSG:4326'});
        const layers = [new ol.layer.Tile({source: new ol.source.OSM(),}), vectorLayer];
        const map = new ol.Map({ layers: layers, target: 'map', view: view,});
        const geolocation = new ol.Geolocation({ trackingOptions: { enableHighAccuracy: true }, projection: view.getProjection(),});
        geolocation.setTracking(1);   

//compass icon
        const iconCar = new ol.Feature({ name: 'Null Island', population: 4000, rainfall: 500, size: [5, 5],});
        const iconStyle = new ol.style.Style({
            image: new ol.style.Icon({
                anchor: [0,5, 1],
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                src: 'https://freeiconshop.com/wp-content/uploads/edd/location-arrow-solid.png',
                rotateWithView: "false",
                scale: 0.1,
            })        
        });
        iconCar.setStyle(iconStyle);
        new ol.layer.Vector({map: map, source: new ol.source.Vector({features: [iconCar],}),});

//update map orientation  
window.addEventListener("deviceorientation", handleOrientation, true);
		
// Center map on coordinates + icon + show latlon 
        navigator.geolocation.watchPosition(function(pos) {
            document.getElementById('accuracy').innerHTML = pos.coords.accuracy
            iconCar.setGeometry([pos.coords.longitude, pos.coords.latitude] ? new ol.geom.Point([pos.coords.longitude, pos.coords.latitude]) : null);
            latitude.innerHTML = pos.coords.latitude;
            longitude.innerHTML = pos.coords.longitude;
            if(pos.coords.altitude != null) {altitude.innerHTML = pos.coords.altitude;}
            view.setCenter([pos.coords.longitude, pos.coords.latitude]);
			currentP = pos.coords;
		});

    
// //start walking
// 		function onStart(){

// 			console.log("start");
// 			console.log("currentP");
// 			console.log(currentP);
// 			startP = {latitude : currentP.latitude, longitude : currentP.longitude, altitude: currentP.altitude};
// 			console.log("starP");
// 			console.log(startP);
// 			// latPstart.innerHTML = currentP.latitude;
// 			// lonPstart.innerHTML = currentP.longitude;
// 			// altPstart.innerHTML = currentP.altitude;
// 			startInfo.innerHTML = "DEPART : " + startP.altitude + "(m d'altitude) - " + startP.latitude + "(lat) - " + startP.longitude + "(lon)";

// 			stop.disabled = false;
// 			start.disabled = true;
			
// 			// latPstop.innerHTML = "";
// 			// lonPstop.innerHTML = "";
// 			// altPstop.innerHTML = "";
// 			stats.innerHTML = "";
//     //             distanceTot = 0;
//     //             startP = pos.coords;
//     //             altitudeMax = startP.altitude;
//     //             altitudeMin = startP.altitude;
// 	// 			drawPoint([startP.longitude, startP.latitude], 4, '#FF0000'); // medium red starting point
// 	// 		    //var lastP = startP;
// 	// 		// 	var currentP = pos.coords;
// 	// 		// 	if (findDistance(lastP,currentP)/1000 > 10) {
// 	// 		// //Show path
// 	// 		// 		drawPoint([currentP.longitude, currentP.latitude], 2, '#0000FF'); // little blue walking point
// 	// 		// 		drawLine([[currentP.longitude, currentP.latitude],[lastP.longitude, lastP.latitude]]);
// 	// 		// //update distances
// 	// 		// 		distanceTot += Math.round(findDistance(A,B)/1000);
// 	// 		// 		if (altitudeMin>currentP.altitude) {altitudeMin = currentP.altitude}
// 	// 		// 		if (altitudeMax<currentP.altitude) {altitudeMax = currentP.altitude}
// 	// 		// //Change old coordinate to new for next operation 
// 	// 		// 		lastP = currentP;
// 		}

// //stop walking and edit stats
// 		function onStop(){
// 			console.log("stop");
// 			stop.disabled = true;
// 			start.disabled = false;
//     //                 endP = pos.coords;
//     //                 console.log("end point : "); ////////////
//     //                 console.log(endP); ////////////
//     //                 stopInfo.innerHTML = "ARRIVEE : " + endP.altitude + "(m d'altitude) - " + endP.latitude + "(lat) - " + endP.longitude + "(lon)";
//     //             // show last step
//     //                 drawPoint([endP.longitude, endP.latitude], 20, '#FF0000'); // big red ending point
//     //                 //drawLine([[endP.longitude, endP.latitude],[lastP.longitude, lastP.latitude]]);
//     //             // //update distances
//     //                 // distanceTot += Math.round(findDistance(endP, lastP)/1000);
//     //         		// if (altitudeMin>endP.altitude) {altitudeMin = endP.altitude}
//     //         		// if (altitudeMax<endP.altitude) {altitudeMax = endP.altitude}
//     //                 stats.innerHTML = "STATISTIQUES : </br>Distance totale en km : " + distanceTot + "</br>Altitude entre " + altitudeMin + " et " + altitudeMax +"</br>(soit un dénivelé de : "+ (altitudeMax-altitudeMin)+").";
//     //             
// 		}

//compass        
        function compassHeading(alpha, beta, gamma) {
            var alphaRad = -alpha * (Math.PI / 180);
            var betaRad = beta * (Math.PI / 180);
            var gammaRad = gamma * (Math.PI / 180);
            betaRad = 1.5707963268;
            var cA = Math.cos(alphaRad);
            var sA = Math.sin(alphaRad);
            var cB = Math.cos(betaRad);
            var sB = Math.sin(betaRad);
            var cG = Math.cos(gammaRad);
            var sG = Math.sin(gammaRad);
            var rA = - cA * sG - sA * sB * cG;
            var rB = - sA * sG + cA * sB * cG;
            var rC = - cB * cG;
            var compassHeading = Math.atan(rA / rB);
            if(rB < 0) {
                compassHeading += Math.PI;
            }else if(rA < 0) {
                compassHeading += 2 * Math.PI;
            }
            return compassHeading;
        }

//update map when compass orientation changes 
        function handleOrientation(event) {
            absolute = event.absolute;
            alpha    = event.alpha;
            beta     = event.beta;
            gamma    = event.gamma;
            if(isNaN(rota_)) {
                rota_ = compassHeading(alpha, beta, gamma);
                //iconStyle.getImage().setRotateWithView(1);
            }else{
                eski_yon = rota_;
                rota_ = compassHeading(alpha, beta, gamma);   
            }
            if(rota_ != null && !isNaN(rota_)) {
                //iconStyle.getImage().setRotateWithView(0);
                map.getView().setRotation(rota_);
            }
            view.setCenter([longitude.innerHTML,latitude.innerHTML]);
        }

//Distance between two points
		function findDistance(A,B) {
			var R = 6371e3; // R is earth’s radius
			var latA = A.latitude;
			var latB = B.latitude;
			var lonA = A.longitude;
			var lonB = B.longitude;
			var latAradians = (latA)*Math.PI/180;
			var latBradians = (latB)*Math.PI/180;
			var latRadians = (latB-latA)*Math.PI/180;
			var lonRadians = (lonB-lonA)*Math.PI/180;
			var x = Math.sin(latRadians/2) * Math.sin(latRadians/2) + Math.cos(latAradians) * Math.cos(latBradians) * Math.sin(lonRadians/2) * Math.sin(lonRadians/2);
			var y = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
			var distance = R * y;
			return distance;
		}

//Draw  ---------------------------------------------------------------------------------------------------------------
		// drawPoint([7.289429, 43.675819], 8, '#FF0000'); // big red point
		// drawPoint([7.0736057, 43.5976677], 3, '#0000FF'); // little blue point
		function drawPoint(coordP, radiusP, colorP)
		{
			var pointStroke = new ol.style.Stroke({color: colorP ,width: 1});
			var pointFill = new ol.style.Fill({color: colorP});
			var circle = new ol.style.Circle({fill: pointFill, stroke: pointStroke, radius: radiusP});
			var style = new ol.style.Style({image: circle});

			var pointFeature = new ol.Feature({});

			pointFeature.setStyle(style);
			new ol.layer.Vector({map: map, source: new ol.source.Vector({features: [pointFeature],}),});
			pointFeature.setGeometry(coordP ? new ol.geom.Point(coordP) : null);
		}

		// drawLine([[7.0736057, 43.5976677],[7.289429, 43.675819]]); // thin black line
		function drawLine(coordsList) {
			var line = new ol.geom.LineString(coordsList);
			var lineStyle= new ol.style.Style({
				stroke: new ol.style.Stroke({color: '#000000',width: 1})
			});
			var lineFeature = new ol.Feature({
				geometry: line
			});
			lineFeature.setStyle(lineStyle);
			new ol.layer.Vector({map: map, source: new ol.source.Vector({features: [lineFeature],}),});
			lineFeature.setGeometry(line);
		}

    </script>
  </body>
</html>
